<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Availability Calendars</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" />
  
  <style>
    /* --- Theme Variables --- */
    :root {
      --primary-color: #ea9999;
      --primary-hover: #fb6161;
      --reserved-color: #e06666;
      --available-color: #b6d7a8;
      --past-color: #e9ecef;
      --text-muted: #adb5bd;
    }

    body {
      padding: 2rem;
      background: #f7f7f7;
      font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif;
    }

    .calendar-wrapper {
      background: #fff;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 4px 15px rgba(0,0,0,0.05);
      margin-bottom: 2rem;
      position: relative;
    }

    .calendar-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1.5rem;
    }

    .calendar-title {
      font-size: 1.25rem;
      font-weight: bold;
      color: #333;
    }

    .nav-btn {
      background: var(--primary-color);
      color: white;
      border: none;
      width: 35px;
      height: 35px;
      border-radius: 50%;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: background 0.3s;
    }
    .nav-btn:hover { background: var(--primary-hover); }

    /* Grid Setup */
    .calendar-grid {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 5px;
    }

    /* Day Names (Mon, Tue...) */
    .day-name {
      text-align: center;
      font-weight: bold;
      color: #777;
      font-size: 0.9rem;
      padding-bottom: 10px;
    }

    /* Day Cells */
    .day-cell {
      aspect-ratio: 1/1; /* Keeps cells square */
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 4px;
      font-weight: 500;
      position: relative;
      cursor: default;
      font-size: 0.9rem;
    }

    /* Status Styles */
    .status-available { background-color: var(--available-color); color: #155724; }
    .status-reserved { background-color: var(--reserved-color); color: white; }
    
    .past-date {
      background-color: var(--past-color);
      color: var(--text-muted);
      cursor: not-allowed;
    }

    .is-today {
      border: 2px solid #007bff;
    }

    .faded { opacity: 0; pointer-events: none; } /* Hide empty cells */

    /* Legend */
    .legend {
      display: flex;
      justify-content: center;
      gap: 15px;
      margin-top: 15px;
      font-size: 0.85rem;
    }
    .legend-item { display: flex; align-items: center; }
    .legend-dot { width: 12px; height: 12px; border-radius: 2px; margin-right: 5px; }

    /* Loading Overlay */
    .loader-overlay {
      position: absolute;
      top: 0; left: 0; width: 100%; height: 100%;
      background: rgba(255,255,255,0.8);
      z-index: 10;
      display: none; /* Hidden by default */
      flex-direction: column;
      justify-content: center;
      align-items: center;
      border-radius: 8px;
    }

    /* CSS Spinner */
    .spinner {
      width: 40px;
      height: 40px;
      border: 4px solid rgba(0,0,0,0.1);
      border-radius: 50%;
      border-left-color: var(--primary-color);
      animation: spin 1s linear infinite;
    }
    @keyframes spin { 100% { transform: rotate(360deg); } }

  </style>
</head>
<body>

<div class="container">
  <div class="row">
    
    <div class="col-lg-6">
      <div class="calendar-wrapper" id="house1-wrapper">
        <div class="loader-overlay">
          <div class="spinner"></div>
        </div>
        
        <div class="calendar-header">
          <button class="nav-btn" onclick="changeMonth('house1', -1)"><i class="fa-solid fa-chevron-left"></i></button>
          <div class="calendar-title" id="house1-title"></div>
          <button class="nav-btn" onclick="changeMonth('house1', 1)"><i class="fa-solid fa-chevron-right"></i></button>
        </div>

        <div class="calendar-grid" id="house1-grid"></div>
        
        <div class="legend">
          <div class="legend-item"><div class="legend-dot status-available"></div>Available</div>
          <div class="legend-item"><div class="legend-dot status-reserved"></div>Reserved</div>
        </div>
      </div>
    </div>

    <div class="col-lg-6">
      <div class="calendar-wrapper" id="house2-wrapper">
        <div class="loader-overlay">
          <div class="spinner"></div>
        </div>

        <div class="calendar-header">
          <button class="nav-btn" onclick="changeMonth('house2', -1)"><i class="fa-solid fa-chevron-left"></i></button>
          <div class="calendar-title" id="house2-title"></div>
          <button class="nav-btn" onclick="changeMonth('house2', 1)"><i class="fa-solid fa-chevron-right"></i></button>
        </div>

        <div class="calendar-grid" id="house2-grid"></div>

        <div class="legend">
          <div class="legend-item"><div class="legend-dot status-available"></div>Available</div>
          <div class="legend-item"><div class="legend-dot status-reserved"></div>Reserved</div>
        </div>
      </div>
    </div>

  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/dayjs@1/dayjs.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/dayjs@1/locale/en-gb.js"></script>
<script>
  // Set Locale to English (Great Britain) so week starts on Monday
  dayjs.locale('en-gb');

  // --- Configuration ---
  const HOUSES = {
    house1: {
      name: 'House 1',
      url: 'https://script.google.com/macros/s/AKfycbz800vAt7-yh-6KuWQVVzQ9Gt6wMyZUSp649RJJYILkFKozrce4Zm61w9E_b3gI6Kmi/exec',
      currentDate: dayjs(),
      data: []
    },
    house2: {
      name: 'House 2',
      url: 'https://script.google.com/macros/s/AKfycbyrUqT0pe9YU_H3L_by_OC72L9-4bSCEpuFRgcgXevr19Dpt63bUDIO9KSMv0MyEhOO/exec',
      currentDate: dayjs(),
      data: []
    }
  };

  // --- Fetch Data ---
  async function fetchHouseData(houseId) {
    const house = HOUSES[houseId];
    const loader = document.querySelector(`#${houseId}-wrapper .loader-overlay`);
    
    loader.style.display = 'flex'; // Show loader

    try {
      const response = await fetch(house.url);
      const json = await response.json();
      house.data = json;
      renderCalendar(houseId);
    } catch (error) {
      console.error(`Error fetching ${house.name}:`, error);
      document.getElementById(`${houseId}-grid`).innerHTML = '<p class="text-center text-danger w-100">Error loading data.</p>';
    } finally {
      loader.style.display = 'none'; // Hide loader
    }
  }

  // --- Render Calendar ---
  function renderCalendar(houseId) {
    const house = HOUSES[houseId];
    const grid = document.getElementById(`${houseId}-grid`);
    const title = document.getElementById(`${houseId}-title`);
    const viewDate = house.currentDate; // The month we are viewing
    const today = dayjs(); // Real today

    grid.innerHTML = '';
    
    // Update Header (e.g., "House 1 - December 2024")
    title.textContent = `${house.name} â€“ ${viewDate.format('MMMM YYYY')}`;

    // 1. Render Day Headers (Mon, Tue...)
    // Start of week in en-gb is Monday. 
    for (let i = 0; i < 7; i++) {
      const dayName = dayjs().day(i + 1).format('ddd'); // +1 because dayjs(0) is Sunday, we want Mon first in loop
      const headerEl = document.createElement('div');
      headerEl.className = 'day-name';
      headerEl.textContent = dayName;
      grid.appendChild(headerEl);
    }

    // 2. Calculate Calendar Cells
    const startOfMonth = viewDate.startOf('month');
    const daysInMonth = viewDate.daysInMonth();
    
    // Calculate empty slots before the 1st of the month
    // day() returns 0 (Sun) to 6 (Sat). We want Mon(1) to be index 0.
    const firstDayIndex = (startOfMonth.day() + 6) % 7; 

    // Add empty slots
    for (let i = 0; i < firstDayIndex; i++) {
      const emptyEl = document.createElement('div');
      emptyEl.className = 'day-cell faded';
      grid.appendChild(emptyEl);
    }

    // Add actual days
    for (let day = 1; day <= daysInMonth; day++) {
      const currentDayDate = startOfMonth.date(day);
      const dateStr = currentDayDate.format('YYYY-MM-DD');
      
      const el = document.createElement('div');
      el.className = 'day-cell';
      el.textContent = day;

      // Check Past Dates
      if (currentDayDate.isBefore(today, 'day')) {
        el.classList.add('past-date');
      } else {
        // Find availability
        const record = house.data.find(r => dayjs(r.Date).format('YYYY-MM-DD') === dateStr);
        const status = record ? (record['Reservation Status'] || '').toLowerCase() : 'unknown';

        if (status === 'available') {
          el.classList.add('status-available');
          el.title = 'Available';
        } else if (status.includes('reserved') || status.includes('booked')) {
          el.classList.add('status-reserved');
          el.title = 'Reserved';
        } else {
          el.style.backgroundColor = '#eee'; 
        }
      }

      // Highlight Today
      if (currentDayDate.isSame(today, 'day')) {
        el.classList.add('is-today');
      }

      grid.appendChild(el);
    }
  }

  // --- Navigation Function ---
  window.changeMonth = function(houseId, delta) {
    HOUSES[houseId].currentDate = HOUSES[houseId].currentDate.add(delta, 'month');
    renderCalendar(houseId);
  };

  // --- Initialize ---
  document.addEventListener('DOMContentLoaded', () => {
    fetchHouseData('house1');
    fetchHouseData('house2');
  });

</script>

</body>
</html>
