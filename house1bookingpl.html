<!DOCTYPE html>
<html lang="pl">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, minimum-scale=1, maximum-scale=1" />
  <title>Domek 1 Rezerwacja</title>

  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/swiper/swiper-bundle.min.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" />

  <style>
    /* --- CSS Variables for Easy Theme Management --- */
    :root {
      --primary-color: #ea9999;
      --primary-hover: #fb6161;
      --border-color: #ff9494;
    }

    html, body {
      position: relative;
      height: 100%;
      background: #eee;
      font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif;
      font-size: 14px;
      color: #333;
      margin: 0;
      padding: 0;
    }

    /* --- Typography & Icons --- */
    .text-theme { color: var(--primary-color) !important; }
    .fa-solid, .fa-users { color: var(--primary-color) !important; }
    
    /* --- Buttons --- */
    .btn-theme {
      color: white;
      background-color: var(--primary-color);
      border-color: var(--border-color);
      transition: all 0.3s;
    }
    .btn-theme:hover, .btn-theme:active {
      background-color: var(--primary-hover);
      border-color: var(--border-color);
      color: white;
    }

    /* --- Swiper --- */
    .swiper {
      max-width: 550px;
      height: 300px;
      width: 100%;
      margin-top: 20px;
      border-radius: 8px;
      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    }
    .swiper-slide {
      text-align: center;
      background: #fff;
      display: flex;
      justify-content: center;
      align-items: center;
    }
    .swiper-slide img {
      display: block;
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    /* --- Card & Layout --- */
    .card-block { padding: 20px; }
    
    /* --- Form Styling --- */
    #form-container {
      margin: 20px auto;
      padding: 30px;
      border: 1px solid #ddd;
      border-radius: 8px;
      background-color: #fff;
      display: flex;
      flex-wrap: wrap;
      justify-content: space-between;
      max-width: 800px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.05);
    }
    #form-container > * { flex-basis: 100%; }
    
    .form-group { margin-bottom: 15px; }
    
    input, select, textarea {
      width: 100%;
      padding: 10px;
      border: 1px solid #ccc;
      border-radius: 4px;
      background-color: #fff;
      box-sizing: border-box;
    }
    
    .read-only-field {
      background-color: #f0f0f0 !important;
      cursor: not-allowed;
      color: #666;
    }

    label {
      display: block;
      margin-bottom: 5px;
      font-weight: 600;
      color: #555;
    }
    
    .required-label::after {
      content: ' *';
      color: red;
    }

    /* Submit Button */
    .submit-button {
      margin-top: 20px;
      padding: 12px 24px;
      border: none;
      border-radius: 4px;
      background-color: var(--primary-color);
      color: #fff;
      font-size: 16px;
      font-weight: bold;
      cursor: pointer;
      width: 100%;
      display: flex;
      justify-content: center;
      align-items: center;
    }
    .submit-button:hover { background-color: var(--primary-hover); }

    .accept-container {
      display: flex;
      align-items: center;
      margin-top: 10px;
    }
    .accept-container input { width: auto; margin-right: 10px; }
    .accept-container label { margin: 0; margin-right: 5px;}

    .separator {
      border: 0;
      border-top: 1px solid #eee;
      margin: 20px 0;
    }

    /* --- Errors --- */
    .error-container {
      color: #dc3545;
      font-size: 12px;
      margin-top: 5px;
    }

    /* --- Loading Spinner --- */
    #loading {
      display: none;
      position: fixed;
      top: 0; left: 0; width: 100%; height: 100%;
      background: rgba(255, 255, 255, 0.8);
      z-index: 9999;
      flex-direction: column;
      justify-content: center;
      align-items: center;
    }
    .loading-icon-btn {
      width: 20px;
      height: 20px;
      display: none;
      margin-left: 10px;
    }
    
    .spinner {
      border: 4px solid rgba(0, 0, 0, 0.1);
      width: 50px;
      height: 50px;
      border-radius: 50%;
      border-left-color: var(--primary-color);
      animation: spin 1s linear infinite;
    }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    
    .swiper-button-next, .swiper-button-prev { color: var(--primary-color); }
  </style>
</head>

<body>

 <div class="swiper mySwiper">
    <div class="swiper-wrapper">
      <div class="swiper-slide"><img src="https://teteje.github.io/assets/house1-salon.jpg" alt="Salon"></div>
      <div class="swiper-slide"><img src="https://teteje.github.io/assets/house1salon2.jpg" alt="Salon View 2"></div>
      <div class="swiper-slide"><img src="https://teteje.github.io/assets/house1salon3.jpg" alt="Salon View 3"></div>
      <div class="swiper-slide"><img src="https://teteje.github.io/assets/house1kitchen.jpg" alt="Kitchen"></div>
      <div class="swiper-slide"><img src="https://teteje.github.io/assets/house1kitchen2.jpg" alt="Kitchen View 2"></div>
      <div class="swiper-slide"><img src="https://teteje.github.io/assets/house1mainroom.jpg" alt="Main Bedroom"></div>
      <div class="swiper-slide"><img src="https://teteje.github.io/assets/house1roomsecond.jpg" alt="Second Room"></div>
      <div class="swiper-slide"><img src="https://teteje.github.io/assets/house1roomsecond2.jpg" alt="Second Room View 2"></div>
      <div class="swiper-slide"><img src="https://teteje.github.io/assets/house1bathroom.jpg" alt="Bathroom"></div>
      <div class="swiper-slide"><img src="https://teteje.github.io/assets/house1games.jpg" alt="Games"></div>
      <div class="swiper-slide"><img src="https://teteje.github.io/assets/house1-all.jpg" alt="Exterior"></div>
    </div>
    <div class="swiper-button-next"></div>
    <div class="swiper-button-prev"></div>
    <div class="swiper-pagination"></div>
  </div>

  <div class="card-block">
    <h4 class="card-title text-theme">Domek 1</h4>
    <div class="text-center mb-4">
      <ul class="list-inline text-sm">
        <li class="list-inline-item me-3"><i class="fa-solid fa-users"></i> 6 Os.</li>
        <li class="list-inline-item me-3"><i class="fa-solid fa-shower"></i> 1 Łazienka</li>
        <li class="list-inline-item me-3"><i class="fa-solid fa-bed"></i> 4 Łóżka</li>
        <li class="list-inline-item me-3"><i class="fa-solid fa-square-parking"></i> 1 Park.</li>
        <li class="list-inline-item me-3"><i class="fa-solid fa-snowflake"></i> Klima</li>
        <li class="list-inline-item me-3"><i class="fa-solid fa-wifi"></i> WiFi</li>
      </ul>
      <a href="https://teteje.github.io/moreinfodomek1pl.html" class="btn btn-theme">Więcej szczegółów</a>
    </div>
  </div>

  <div id="form-container">
    </div>

  <div id="loading">
    <div class="spinner"></div>
    <p style="margin-top: 15px; font-weight: bold;">Przetwarzanie rezerwacji...</p>
    <p style="font-size: 12px; color: #666;">Może to potrwać do 15 sekund</p>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/swiper/swiper-bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/dayjs@1/dayjs.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/dayjs@1/plugin/isBetween.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>

  <script>
    var swiper = new Swiper(".mySwiper", {
      slidesPerView: "auto",
      spaceBetween: 10,
      pagination: { el: ".swiper-pagination", type: "progressbar" },
      navigation: { nextEl: ".swiper-button-next", prevEl: ".swiper-button-prev" },
    });
  </script>

  <script>
    dayjs.extend(window.dayjs_plugin_isBetween);

    $(document).ready(function() {
      
      // ==========================================
      // CONFIGURATION & PRICING LOGIC
      // ==========================================
      
      // 1. Define Price List for 2026 onwards
      const PRICES_2026 = {
        '1-2': 410,
        '3': 440,
        '4': 470,
        '5-6': 530
      };

      // 2. Define Special Date Ranges for 2026
      // Format: [Start Date, End Date (Inclusive)]
      const SPECIAL_RANGES_2026 = [
        ['2026-04-04', '2026-04-06']
        ['2026-05-01', '2026-05-03'], // Majówka (May long weekend)
        ['2026-12-24', '2026-12-26'], // Christmas
        ['2026-12-31', '2027-01-01']  // Sylvester / New Year
      ];

      // Helper: Check if a date falls within special ranges
      function isSpecialDay(dateString) {
        const checkDate = dayjs(dateString);
        
        // 1. Check 2026 Ranges
        for (let range of SPECIAL_RANGES_2026) {
          if (checkDate.isBetween(range[0], range[1], 'day', '[]')) {
            return true;
          }
        }
        return false;
      }

      function getPriceForNight(dateObj, guests) {
        const year = dateObj.year();
        const dateString = dateObj.format('YYYY-MM-DD');
        let basePrice = 0;

        // --- LOGIC FOR 2026 ONWARDS ---
        if (year >= 2026) {
          // Get Base Price
          if (guests <= 2) basePrice = PRICES_2026['1-2'];
          else if (guests === 3) basePrice = PRICES_2026['3'];
          else if (guests === 4) basePrice = PRICES_2026['4'];
          else basePrice = PRICES_2026['5-6'];

          // Apply 10% Increase for Special Days
          if (isSpecialDay(dateString)) {
            // Logic: Base + 10%, rounded up to nearest integer
            return Math.ceil(basePrice * 1.10);
          }
          
          return basePrice;
        } 
        
        // --- LOGIC FOR 2025 (Fallback/Transition) ---
        // Assuming Standard Rate for 2025 based on previous logic
        if (guests <= 2) return 400;
        if (guests === 3) return 420;
        if (guests === 4) return 450;
        return 490;
      }

      function calculateTotalPrice(startDateStr, endDateStr, numberOfGuests) {
        if (!startDateStr || !endDateStr) return 0;

        const start = dayjs(startDateStr);
        const end = dayjs(endDateStr);
        const numberOfNights = end.diff(start, 'day'); // Exclude end date for checkout

        let totalPrice = 0;

        for (let i = 0; i < numberOfNights; i++) {
          let currentNight = start.add(i, 'day');
          totalPrice += getPriceForNight(currentNight, numberOfGuests);
        }

        return totalPrice;
      }

      // ==========================================
      // FORM BUILDING & UI (POLISH)
      // ==========================================

      var priceInput; // Global ref

      function buildForm() {
        var $container = $('#form-container');
        $container.empty();

        // 1. Read-only Dates & Price
        $container.append(createField('text', 'from', 'Zameldowanie:', true));
        $container.append(createField('text', 'to', 'Wymeldowanie:', true));
        
        var $priceGroup = createField('text', 'price', 'Cena (PLN):', true);
        priceInput = $priceGroup.find('input'); // Store reference
        $container.append($priceGroup);

        // 2. Guest Selection
        var $guestLabel = $('<label>').addClass('required-label').text('Liczba gości:');
        var $guestSelect = $('<select>').attr('name', 'numberOfGuests').prop('required', true);
        
        $guestSelect.append('<option value="1">1 osoba</option>');
        $guestSelect.append('<option value="2">2 osoby</option>');
        $guestSelect.append('<option value="3">3 osoby</option>');
        $guestSelect.append('<option value="4">4 osoby</option>');
        $guestSelect.append('<option value="5">5 osób</option>');
        $guestSelect.append('<option value="6">6 osób</option>');
        
        $container.append($('<div>').addClass('form-group').append($guestLabel).append($guestSelect));

        // 3. User Details
        $container.append(createField('text', 'name', 'Imię i nazwisko:', false, true));
        $container.append(createField('text', 'address', 'Adres:', false, true));
        $container.append(createField('email', 'email', 'Email:', false, true));
        $container.append(createField('tel', 'phone', 'Nr kontaktowy:', false, true));
        
        // 4. Comments
        var $commentLabel = $('<label>').text('Uwagi:');
        var $commentArea = $('<textarea>').attr('name', 'comments').attr('rows', 3);
        $container.append($('<div>').addClass('form-group').append($commentLabel).append($commentArea));

        // 5. Terms
        var $acceptDiv = $('<div>').addClass('accept-container');
        var $acceptInput = $('<input>').attr('type', 'checkbox').attr('name', 'accept');
        var $acceptLabel = $('<label>').addClass('required-label').text('Zapoznałem się z regulaminem obiektu: ');
        var $link = $('<a>').attr('href', 'https://www.napanskiejgorze.com/regulamin').attr('target', '_blank').text('Regulamin obiektu');
        $acceptDiv.append($acceptLabel).append($acceptInput).append($link);
        $container.append($acceptDiv);

        $container.append('<hr class="separator">');

        // 6. Submit Button
        var $btn = $('<button>').attr('type', 'submit').attr('id', 'submitBtn').addClass('submit-button')
          .html('<span class="btn-text">Rezerwacja!</span><img src="https://media.tenor.com/On7kvXhzml4AAAAj/loading-gif.gif" class="loading-icon-btn" />');
        $container.append($btn);

        // --- Event Listeners for Price Updates ---
        const urlParams = new URLSearchParams(window.location.search);
        const checkin = urlParams.get('checkin');
        const checkout = urlParams.get('checkout');

        // Pre-fill
        $('input[name="from"]').val(checkin);
        $('input[name="to"]').val(checkout);

        function refreshPrice() {
          const guests = parseInt($guestSelect.val());
          const total = calculateTotalPrice(checkin, checkout, guests);
          priceInput.val(total);
        }

        $guestSelect.on('change', refreshPrice);
        
        // Initial Calculation
        refreshPrice();
      }

      // Helper to create standard fields
      function createField(type, name, labelText, isReadOnly, isRequired) {
        var $div = $('<div>').addClass('form-group');
        var $label = $('<label>').text(labelText);
        if (isRequired) $label.addClass('required-label');
        
        var $input = $('<input>').attr('type', type).attr('name', name);
        if (isReadOnly) $input.addClass('read-only-field').prop('readonly', true);
        if (isRequired) $input.prop('required', true);

        return $div.append($label).append($input);
      }

      // Initialize
      buildForm();

      // ==========================================
      // FORM SUBMISSION & VALIDATION
      // ==========================================
      $('#submitBtn').on('click', function(e) {
        e.preventDefault();
        $('.error-container').remove(); // Clear previous errors

        var isValid = true;
        var formData = {};

        // 1. Basic Fields Check (Map English logic to Polish labels for validation if needed, but keeping keys same)
        var validationMap = {
            'numberOfGuests': 'Liczba gości',
            'name': 'Imię i nazwisko',
            'address': 'Adres',
            'email': 'Email',
            'phone': 'Nr kontaktowy'
        };

        for (var key in validationMap) {
            var val = $(`[name="${key}"]`).val();
            formData[key] = val;
            if (!val) {
                isValid = false;
                showError(key, 'Proszę wypełnić: ' + validationMap[key] + '.');
            }
        }

        // 2. Terms Check
        if (!$('[name="accept"]').is(':checked')) {
          isValid = false;
          showError('accept', 'Proszę zaakceptować regulamin.');
        }

        // 3. Regex Validation
        // Email
        if (formData.email && !/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(formData.email)) {
           isValid = false; showError('email', 'Proszę podać poprawny adres e-mail.');
        }
        // Phone (Allows + and digits)
        if (formData.phone && !/^[\+]?[(]?[0-9]{3}[)]?[-\s\.]?[0-9]{3}[-\s\.]?[0-9]{4,6}$/im.test(formData.phone)) {
           isValid = false; showError('phone', 'Proszę podać poprawny numer telefonu.');
        }

        if (isValid) {
          // Add Read-only data to payload
          formData.checkin = $('input[name="from"]').val();
          formData.checkout = $('input[name="to"]').val();
          formData.price = priceInput.val();
          formData.comments = $('textarea[name="comments"]').val();
          formData.accept = "Accepted";

          // UI Loading State
          $('#loading').css('display', 'flex'); // Show Full screen loader
          var $btn = $('#submitBtn');
          $btn.prop('disabled', true);
          
          $.ajax({
            url: 'https://script.google.com/macros/s/AKfycbz96K3JPVWSXztUaUsc8IvtJU5PMPGPg2k6zWDlQj3VPGUBOBbKOJAv37jBQIqb-xCv/exec',
            type: 'POST',
            data: formData,
            success: function() { window.location.href = 'https://teteje.github.io/congratspl.html'; },
            error: function() { window.location.href = 'https://teteje.github.io/congratspl.html'; }, 
            complete: function() {
               $('#loading').hide();
            }
          });
        }
      });

      function showError(fieldName, msg) {
        var $el = fieldName === 'accept' ? $('.accept-container') : $(`[name="${fieldName}"]`);
        var $err = $('<div>').addClass('error-container').text(msg);
        $el.after($err);
      }
    });
  </script>
</body>
</html>
