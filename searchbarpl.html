<!DOCTYPE html>
<html lang="pl">
<head>
  <meta charset="UTF-8">
  <title>Sprawdź Dostępność</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" />
  <link rel="stylesheet" href="https://code.jquery.com/ui/1.13.0/themes/base/jquery-ui.css">

  <style>
    /* --- Theme Variables --- */
    :root {
      --primary-color: #ea9999;
      --primary-hover: #fb6161;
      --bg-color: #eee;
    }

    html, body {
      height: 100%;
      margin: 0;
      padding: 0;
      font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif;
      background: var(--bg-color);
    }

    .container-box {
      max-width: 500px;
      margin: 40px auto;
      padding: 30px;
      background: #fff;
      border-radius: 8px;
      box-shadow: 0 4px 15px rgba(0,0,0,0.1);
    }

    h3 {
      text-align: center;
      margin-bottom: 25px;
      color: #333;
      font-weight: 600;
    }

    label {
      font-weight: 600;
      color: #555;
    }

    /* Custom Input Styling */
    input[type="text"] {
      width: 100%;
      padding: 10px;
      border: 1px solid #ced4da;
      border-radius: 4px;
      margin-bottom: 15px;
      background-color: #fff;
    }
    input[type="text"]:focus {
      border-color: var(--primary-color);
      outline: none;
      box-shadow: 0 0 0 0.2rem rgba(234, 153, 153, 0.25);
    }

    /* Button Styling */
    .btn-theme {
      background-color: var(--primary-color);
      color: #fff;
      border: none;
      padding: 10px 20px;
      border-radius: 4px;
      width: 100%;
      font-size: 16px;
      font-weight: bold;
      transition: background 0.3s;
      cursor: pointer;
    }
    .btn-theme:hover {
      background-color: var(--primary-hover);
      color: #fff;
    }

    /* Message Box */
    #message {
      margin-top: 20px;
      min-height: 20px;
    }

    .availability-card {
      background: #f8f9fa;
      border-left: 5px solid var(--primary-color);
      padding: 15px;
      margin-bottom: 10px;
      border-radius: 4px;
    }

    .booking-btn {
      display: inline-block;
      margin-top: 5px;
      padding: 6px 12px;
      background: var(--primary-color);
      color: #fff;
      border-radius: 4px;
      text-decoration: none;
      font-size: 14px;
    }
    .booking-btn:hover {
      background: var(--primary-hover);
      color: white;
      text-decoration: none;
    }

    .error-message { color: #dc3545; font-weight: bold; text-align: center; }

    /* Hidden Container (No Availability) */
    #hiddenContainer {
      display: none;
      margin-top: 20px;
      padding: 15px;
      background: #fff;
      border: 1px solid #ddd;
      border-radius: 4px;
      text-align: center;
    }

    /* CSS Spinner */
    .spinner {
      display: none;
      width: 24px;
      height: 24px;
      border: 3px solid rgba(255,255,255,0.3);
      border-radius: 50%;
      border-top-color: #fff;
      animation: spin 1s ease-in-out infinite;
      margin-left: 10px;
      vertical-align: middle;
    }
    @keyframes spin { to { transform: rotate(360deg); } }
    
    /* Center content in button */
    #searchButton { display: flex; justify-content: center; align-items: center; }

    /* Datepicker Customization */
    .ui-datepicker { font-family: Arial, sans-serif; }
    .ui-widget-header { background: var(--primary-color); border: 1px solid var(--border-color); color: white; }
    .ui-state-highlight, .ui-widget-content .ui-state-highlight { border-color: var(--primary-color); background: #fff5f5; color: #333; }
    .ui-state-active, .ui-widget-content .ui-state-active { border-color: var(--primary-color); background: var(--primary-color); color: white; }
  </style>

  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://code.jquery.com/ui/1.13.0/jquery-ui.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/dayjs@1/dayjs.min.js"></script>
  
  <script>
    $(document).ready(function() {
      
      // 1. Polish Localization for Datepicker (Embedded)
      $.datepicker.regional['pl'] = {
        closeText: "Zamknij",
        prevText: "&#x3C;Poprzedni",
        nextText: "Następny&#x3E;",
        currentText: "Dziś",
        monthNames: [ "Styczeń","Luty","Marzec","Kwiecień","Maj","Czerwiec",
        "Lipiec","Sierpień","Wrzesień","Październik","Listopad","Grudzień" ],
        monthNamesShort: [ "Sty","Lu","Mar","Kw","Maj","Cze",
        "Lip","Sie","Wrz","Pa","Lis","Gru" ],
        dayNames: [ "Niedziela","Poniedziałek","Wtorek","Środa","Czwartek","Piątek","Sobota" ],
        dayNamesShort: [ "Nie","Pn","Wt","Śr","Czw","Pt","So" ],
        dayNamesMin: [ "N","Pn","Wt","Śr","Cz","Pt","So" ],
        weekHeader: "Tydz",
        dateFormat: "yy-mm-dd",
        firstDay: 1,
        isRTL: false,
        showMonthAfterYear: false,
        yearSuffix: ""
      };
      $.datepicker.setDefaults($.datepicker.regional['pl']);

      // 2. Initialize Datepickers
      var currentDate = new Date();
      
      $("#checkin").datepicker({
        minDate: currentDate,
        onSelect: function(selectedDate) {
          var minDate = new Date(selectedDate);
          minDate.setDate(minDate.getDate() + 2); // Minimum 2 nights
          $("#checkout").datepicker("option", "minDate", minDate);
          
          // Auto-adjust checkout if invalid
          var checkoutDate = $("#checkout").datepicker("getDate");
          if (checkoutDate && checkoutDate < minDate) {
             $("#checkout").datepicker("setDate", minDate);
          }
        }
      });

      $("#checkout").datepicker({
        onSelect: function() {
          // Optional: Auto search on checkout select
          // checkAvailability(); 
        }
      });
      
      // Make inputs readonly to force using the picker
      $("#checkin, #checkout").prop("readonly", true);


      // 3. Search Logic
      $("#searchButton").click(async function() {
        var checkinDateStr = $("#checkin").val();
        var checkoutDateStr = $("#checkout").val();

        // UI Reset
        $("#message").empty();
        $("#hiddenContainer").hide();
        var $btn = $(this);
        var $spinner = $btn.find(".spinner");
        
        // Validation
        if (!checkinDateStr || !checkoutDateStr) {
          $("#message").html("<p class='error-message'>Proszę wybrać daty zameldowania i wymeldowania.</p>");
          return;
        }

        // Calculate Duration using DayJS
        var start = dayjs(checkinDateStr);
        var end = dayjs(checkoutDateStr);
        var diff = end.diff(start, 'day');

        if (diff < 2) {
          $("#message").html("<p class='error-message'>Minimalna długość pobytu to 2 noce.</p>");
          return;
        }

        // Start Loading
        $btn.prop("disabled", true);
        $spinner.show();
        $btn.find("span").text("Szukam...");

        // URLs
        const url1 = 'https://script.google.com/macros/s/AKfycbz800vAt7-yh-6KuWQVVzQ9Gt6wMyZUSp649RJJYILkFKozrce4Zm61w9E_b3gI6Kmi/exec';
        const url2 = 'https://script.google.com/macros/s/AKfycbyrUqT0pe9YU_H3L_by_OC72L9-4bSCEpuFRgcgXevr19Dpt63bUDIO9KSMv0MyEhOO/exec';

        try {
          // Fetch Data in Parallel
          let [house1Data, house2Data] = await Promise.all([
            fetch(url1).then(res => res.json()),
            fetch(url2).then(res => res.json())
          ]);

          // Helper to check range availability
          const checkRange = (data) => {
             // We check every night from Checkin up to (but not including) Checkout
             // i.e., staying 23rd-25th means we need night of 23rd and 24th available.
             let current = start.clone();
             while (current.isBefore(end)) {
               let dateStr = current.format("YYYY-MM-DD");
               // Find entry in JSON
               // Note: Your JSON usually returns ISO strings, DayJS handles parsing
               let entry = data.find(d => dayjs(d.Date).format("YYYY-MM-DD") === dateStr);
               
               if (!entry || entry["Reservation Status"] !== "Available") {
                 return false; 
               }
               current = current.add(1, 'day');
             }
             return true;
          };

          let house1Avail = checkRange(house1Data);
          let house2Avail = checkRange(house2Data);

          // Build Result HTML
          let html = "";
          
          if (house1Avail) {
            html += `
              <div class="availability-card">
                <strong>Domek 1</strong> jest dostępny.<br>
                <a href='https://teteje.github.io/house1bookingpl.html?checkin=${checkinDateStr}&checkout=${checkoutDateStr}' class='booking-btn'>Rezerwuj Domek 1</a>
              </div>`;
          }
          
          if (house2Avail) {
             html += `
              <div class="availability-card">
                <strong>Domek 2</strong> jest dostępny.<br>
                <a href='https://teteje.github.io/house2bookingpl.html?checkin=${checkinDateStr}&checkout=${checkoutDateStr}' class='booking-btn'>Rezerwuj Domek 2</a>
              </div>`;
          }

          if (!house1Avail && !house2Avail) {
            $("#message").html(`<p class='error-message'>Brak dostępności w terminie ${checkinDateStr} - ${checkoutDateStr}.</p>`);
            $("#hiddenContainer").fadeIn();
          } else {
            $("#message").html(html);
          }

        } catch (error) {
          console.error(error);
          $("#message").html("<p class='error-message'>Wystąpił błąd połączenia. Spróbuj ponownie.</p>");
        } finally {
          // Stop Loading
          $btn.prop("disabled", false);
          $spinner.hide();
          $btn.find("span").text("Szukaj");
        }
      });
    });
  </script>
</head>
<body>

  <div class="container-box">
    <h3>Wyszukiwanie Dostępności</h3>
    
    <label for="checkin">Data zameldowania:</label>
    <div class="input-group">
      <input type="text" id="checkin" placeholder="Wybierz datę" autocomplete="off">
    </div>

    <label for="checkout">Data wymeldowania:</label>
    <div class="input-group">
      <input type="text" id="checkout" placeholder="Wybierz datę" autocomplete="off">
    </div>

    <button id="searchButton" class="btn-theme">
      <span>Szukaj</span>
      <div class="spinner"></div>
    </button>

    <div id="message"></div>
  </div>

  <div id="hiddenContainer" class="container-box">
    <p style="margin-bottom: 15px;">Brak dostępnych dat w wybranym okresie?<br>Sprawdź pełny kalendarz:</p>
    <a href="https://teteje.github.io/avialabilitycalendarpl.html" class="btn-theme" style="text-decoration:none; display:inline-block; width:auto;">Sprawdź Kalendarz</a>
  </div>

</body>
</html>
